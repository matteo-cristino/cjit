name: cjit
on:
  push:
    paths-ignore:
      - 'docs/**'
      - '*.md'
    branches:
      - main
  pull_request:
    paths-ignore:
      - 'docs/**'
      - '*.md'
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  reuse:
    name: 🚨 REUSE Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: fsfe/reuse-action@v4


  c-lint:
    name: 🚨 C lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: reviewdog/action-cpplint@master
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-check
          targets: --recursive src
          level: warning
          flags: --linelength=120 # Optional
          filter: "-readability/braces\
            ,-readability/casting\
            ,-whitespace/comma\
            ,-whitespace/braces\
            ,-whitespace/comments\
            ,-whitespace/indent\
            ,-whitespace/newline\
            ,-whitespace/operators\
            ,-whitespace/parens\
            ,-whitespace/tab\
            " # Optional
        #    - name: Fail fast?!
        #      if: steps.linter.outputs.checks-failed > 0
        #      run: |
        #        echo "😤 Some files failed the C linting checks!"

  musl-test:
    name: 🐧 Musl Linux build and test
    needs: [reuse, c-lint]
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: install dependencies
        run: |
          sudo apt install -yq musl-tools musl-dev
      - name: Build x86_64 with musl-system
        run: |
          make
      - name: Run tests
        run: |
          make check

  semantic-release:
    name: 🤖 Semantic release
    needs: [musl-test]
    runs-on: ubuntu-latest
    if: ${{ github.ref_name == 'main' && github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4
      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        with:
          extra_plugins: |
            @semantic-release/changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  musl-release:
    name: 🐧 Musl Linux binary release build
    runs-on: ubuntu-latest
    needs: [semantic-release]
    if: ${{ needs.semantic-release.outputs.new_release_published == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Upload release docs artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: |
            build/release-intro.md
      - name: Install build deps
        run: |
          sudo apt install -qy make musl-tools musl-dev
      - name: Build x86_64 with musl-system
        run: |
          make
      - name: Upload artifact linux-amd64
        uses: actions/upload-artifact@v4
        with:
          name: release-musl-linux-x86_64
          path: |
            cjit
      - name: Clean for next build
        run: make clean
